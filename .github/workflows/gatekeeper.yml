name: CI Skip Detection

on:
  workflow_call:
    outputs:
      skip_check:
        description: "The result of the skip detection"
        value: ${{ jobs.detect.outputs.skip_check }}

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      skip_check: ${{ steps.final_decision.outputs.skip_check }}
    steps:
      # Check for PR label directly
      - name: Detect label in Pull Request
        id: skip_in_pr
        if: github.event_name == 'pull_request'
        run: |
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'skip-ci-non-code-change') }}" == "true" ]]; then
            echo "skip_check=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip_check=false" >> "$GITHUB_OUTPUT"
          fi

      # Check for MQ
      - name: Detect label in merge queue
        if: github.event_name == 'merge_group'
        id: skip_in_merge_queue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Last commit message: $COMMIT_MSG"

          # Extract PR number from commit message if it follows conventional format
          PR_NUMBER=""
          if echo "$COMMIT_MSG" | grep -q "#"; then
            PR_NUMBER=$(echo "$COMMIT_MSG" | grep -o "#[0-9]*" | grep -o "[0-9]*")
          fi

          if [ -n "$PR_NUMBER" ]; then
            echo "Found PR number: $PR_NUMBER"

            LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name' 2>/dev/null || true)
            echo "PR labels:"
            echo "$LABELS"

            # Extract packages from "breaking-change-" labels
            PACKAGES=""
            if [ -n "$LABELS" ]; then
              # -o: only output matches, not rows
              # -P: Perl-compatible regular expressions
              # `(?<=)`: look-behind: match only if this is present, but do not make this part of the match
              PACKAGES=$(echo "$LABELS" \
                | grep -oP '(?<=^breaking-change-)[a-z0-9-]+$' || true \
                | tr '\n' ',' \
                | sed 's/,$//')

              if [ -n "$PACKAGES" ]; then
                # TODO: skip only specific packages, not the whole check
                echo "Breaking change made for package(s): $PACKAGES"
                echo "skip_check=true" >> "$GITHUB_OUTPUT"
              else
                echo "No breaking-change-* labels found"
                echo "skip_check=false" >> "$GITHUB_OUTPUT"
              fi
            else
              echo "No labels found in commit message"
              echo "skip_check=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "No PR number found in commit message"
            echo "skip_check=false" >> "$GITHUB_OUTPUT"
          fi

      # Check final decision
      - name: Final Decision
        id: final_decision
        run: |
          PR_SKIP="${{ steps.skip_in_pr.outputs.skip_check }}"
          MQ_SKIP="${{ steps.skip_in_merge_queue.outputs.skip_check }}"

          if [[ "$PR_SKIP" == "true" || "$MQ_SKIP" == "true" ]]; then
            echo "skip_check=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip_check=false" >> "$GITHUB_OUTPUT"
          fi
